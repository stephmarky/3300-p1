<html>
<head>
<title>3300 P1</title>
<link href="https://fonts.googleapis.com/css?family=Barlow+Condensed" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<style>
body { font-family: 'Barlow Condensed', Calibri, sans-serif; }
svg { border: solid #ccc 1px; }
path.country { fill: #ccc; stroke: #888; stroke-width: 0.3; }
</style>
</head>
<body>

<!-- Europe: viewbox="450 160 200 300" -->
<!-- world: viewbox="320 90 300 350" -->
<svg id="graph2" height="1000" width="1000"  viewbox="450 160 200 300" > </svg>

<!-- svg for scales and map keys -->
<svg id="keys" height="150" width="1000">
    <defs>
      <linearGradient id="happinessGradient" x1="0" x2="1" y1="0" y2="0">
        <stop offset="0%" stop-color="#cc0000"/>
        <stop offset="50%" stop-color="#ffff00"/>
        <stop offset="100%" stop-color="#329932"/>
      </linearGradient>
      
  </defs>
</svg>

<script id="notes">

var svg = d3.select("#graph2");

var projection = d3.geoEquirectangular().scale(75);
var pathGenerator = d3.geoPath().projection(projection);

var happinessColors = ['#cc0000', '#ffff00', '#329932']

var percentScale = d3.scaleLinear().domain([5.19, 6.36, 7.53]).range(happinessColors);

var countries;
var atlas;



// function to handle any row-by-row processing on CSV
var parseRow = function(row) {
  return row;
}

// Creates a scale to bring x coordinates to the size of the svg map
// TODO: range needs to be adjusted
var coordinatesXScale= d3.scaleLinear()
.domain([-180, 180])
.range([0, 1000])

// Creates a scale to bring y coordinates to the size of the svg map
// TODO: range needs to be adjusted
var coordinatesYScale= d3.scaleLinear()
.domain([-90, 90])
.range([1000, 0])

var gradient = svg.append()


// GENERAL HELPERS!

// Next we use a powerScale with exponent 0.5 to change the initial variable
// such that the area is linear and correct
var areaScale= d3.scalePow().
exponent([1]);

// Since attr modification takes in a string, we must transform each scale value
// into a string such that .attr("transform", to_string_scale(value)) is in
// an acceptable format
var to_string_scale= function(variable) {
  return "scale(" + variable + ", " + variable + ")";
};

// Transforms x and y coordinates into a translate function string input
// so that it is compatible with a .attr call
var to_string_x_y= function(x, y) {
  return "translate(" + x + "," + y + ")";
};

// Concatenates the transform functions into one, else overwriting will occur
var transformHelper= function(x, y, imageHelperUsed, dataPoint) {
  return to_string_x_y(x, y) + " " + imageHelperUsed(dataPoint);
};


// Pill linear
// Pill data to linear scale
var linearPillsScale= d3.scaleLinear()
.domain([0, 10000])
.range([0, 20]);

// Pill sizing
var pillsImageHelper= function(healthData) {
  return to_string_scale(areaScale(linearPillsScale(healthData)));
};

// Select svg2 for pills
var svg2= d3.select("#graph2");

var pillGenerator= function (d) {
  var image= svg2.append("g")
  .attr("transform", transformHelper(projection(d.coordinates)[0], 
    projection(d.coordinates)[1], 
    pillsImageHelper, d.pills));

  var innerimage= image.append("g")
  .attr("transform", "translate(-29, -29)")
  .attr("opacity", "0.75")

  innerimage.append("path")
  .attr("d", "M17.775,17.594L4.667,30.702c-6.223,6.223-6.223,16.405,0,22.627h0   c6.223,6.223,16.405,6.223,22.627,0l13.108-13.108L17.775,17.594z")
  .style("fill", "#DD352E")

  innerimage.append("path")
  .attr("d", "M40.422,40.202l12.908-12.907c6.222-6.223,6.222-16.405,0-22.627h0   c-6.223-6.223-16.405-6.223-22.627,0L17.794,17.574L40.422,40.202z")
  .style("fill", "#EBBA16")

  innerimage.append("path")
  .attr("d", "M22.046,21.826l-17.11,17.11c-0.586,0.585-0.586,1.536,0,2.121c0.293,0.293,0.677,0.439,1.061,0.439   s0.768-0.146,1.061-0.439l17.11-17.11L22.046,21.826z")
  .style("fill", "#F46767")

  innerimage.append("path")
  .attr("d", "M24.165,23.948L40.057,8.057c0.586-0.585,0.586-1.536,0-2.121c-0.586-0.586-1.535-0.586-2.121,0   L22.044,21.827L24.165,23.948z")
  .style("fill", "#FCD770")
}


d3.queue()
.defer(d3.json, "world-50m.json")
.defer(d3.csv, "FINAL_DATA.csv", parseRow)
.await(callback);


function callback (error, rawMap, rawISO) {
  console.log("Code in the call-back function is only executed when every data file loads.");

  rawcsvdata = rawISO;
  rawcsvdata.forEach(function(d) {
    d.coordinates = d.coordinates.split(",").map(function(x){return Number(x)});
    d.countryid = Number(d.countryid);
    d.happiness = Number(d.happiness);
    d.health = Number(d.health);
    d.corruption = Number(d.corruption);
    d.education = Number(d.education);
    d.pills = Number(d.pills);
  });

  atlas = d3.map(rawISO, function (d) {
    return Number(d.countryid); 
  });
  
  countries = topojson.feature(rawMap, rawMap.objects.countries);
  
  showMap(percentScale, "happiness");

  makeHappyScale("#keys");
  

  rawcsvdata.forEach(function (d) {
    pillGenerator(d);
  });

  svg.append("circle")
  .attr("cx", function(d){
    return projection([56,59])[0];
  })
  .attr("cy", function(d){
    return projection([56,59])[1];
  })
  .attr("r", 5)

}


function showMap(scale, variable) {

  projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], countries);
  pathGenerator = d3.geoPath().projection(projection);
  
  var paths = svg.selectAll("path.country").data(countries.features);
  
  paths = paths.enter().append("path").attr("class", "country")
  .on("click", function (d) { console.log(d.id); })
  .merge(paths);
  
  paths
  .transition().duration(1000)
  .style("fill", function (country) {
    var countryData = atlas.get(country.id);
    if (countryData) {
      return scale(countryData[variable]);
    }
  })

  .attr("d", function (country) {
    return pathGenerator(country);
  });
  
}

  function makeHappyScale(svg){
    // var happyLinScale = d3.scaleLinear()
    // .domain([0, 1000])
    // .range([0, 150]);

    var svg = d3.select(svg);

    var gradient = svg.append("rect")
      .attr("x", "30")
      .attr("y", "90")
      .attr("width", "400")
      .attr("height", "30")
      .attr("fill", "url(#happinessGradient)")

    var happyImage= svg.append("g")
      .attr("transform", "translate(410, 40) scale(.10)");

    happyImage.append("path")
    .attr("d", "M409.132,109.205c-19.608-33.592-46.205-60.189-79.798-79.796C295.733,9.803,259.054,0.002,219.273,0.002 c-39.781,0-76.47,9.801-110.063,29.407c-33.595,19.604-60.192,46.201-79.8,79.796C9.801,142.802,0,179.491,0,219.269 c0,39.78,9.804,76.463,29.407,110.062c19.607,33.592,46.204,60.189,79.799,79.798c33.597,19.603,70.283,29.403,110.063,29.403 s76.47-9.801,110.065-29.403c33.593-19.608,60.189-46.206,79.795-79.798c19.603-33.599,29.403-70.284,29.403-110.062 C438.533,179.487,428.732,142.797,409.132,109.205z M387.433,290.215c-9.709,22.556-22.696,41.973-38.969,58.245 c-16.271,16.269-35.689,29.26-58.245,38.965c-22.555,9.712-46.202,14.564-70.946,14.564c-24.744,0-48.391-4.859-70.948-14.564 c-22.554-9.705-41.971-22.696-58.245-38.965c-16.269-16.275-29.259-35.687-38.97-58.245 c-9.707-22.552-14.562-46.206-14.562-70.946c0-24.744,4.854-48.391,14.562-70.948c9.707-22.554,22.697-41.968,38.97-58.245 c16.274-16.269,35.691-29.26,58.245-38.97c22.554-9.704,46.205-14.558,70.948-14.558c24.74,0,48.395,4.851,70.946,14.558 c22.556,9.707,41.97,22.698,58.245,38.97c16.272,16.274,29.26,35.688,38.969,58.245c9.709,22.554,14.564,46.201,14.564,70.948 C402.001,244.013,397.142,267.666,387.433,290.215z")

    happyImage.append("path")
    .attr("d", "M312.06,247.533c-4.757-1.532-9.418-1.136-13.99,1.144s-7.617,5.899-9.13,10.849 c-4.754,15.229-13.562,27.555-26.412,36.973c-12.844,9.421-27.265,14.134-43.255,14.134c-15.986,0-30.402-4.716-43.252-14.134 c-12.847-9.421-21.65-21.744-26.409-36.973c-1.521-4.949-4.521-8.569-8.992-10.849c-4.473-2.279-9.087-2.676-13.846-1.144 c-4.949,1.52-8.564,4.518-10.85,8.987c-2.284,4.469-2.666,9.096-1.141,13.846c7.039,23.038,20.173,41.593,39.397,55.679 c19.226,14.086,40.924,21.121,65.096,21.121c24.169,0,45.873-7.035,65.098-21.121c19.212-14.093,32.347-32.641,39.389-55.679 c1.533-4.75,1.15-9.377-1.136-13.846C320.334,252.051,316.81,249.061,312.06,247.533z")

    happyImage.append("path")
    .attr("d", "M146.181,182.727c10.085,0,18.699-3.576,25.837-10.709c7.139-7.135,10.708-15.749,10.708-25.837 c0-10.089-3.569-18.699-10.708-25.837s-15.752-10.709-25.837-10.709c-10.088,0-18.702,3.571-25.84,10.709 c-7.135,7.139-10.707,15.749-10.707,25.837c0,10.088,3.568,18.702,10.707,25.837C127.482,179.154,136.092,182.727,146.181,182.727 z")

    happyImage.append("path")
    .attr("d", "M292.359,109.633c-10.089,0-18.706,3.571-25.845,10.709c-7.132,7.139-10.708,15.749-10.708,25.837 c0,10.088,3.576,18.702,10.708,25.837c7.139,7.137,15.756,10.709,25.845,10.709c10.081,0,18.698-3.576,25.837-10.709 c7.139-7.135,10.708-15.749,10.708-25.837c0-10.089-3.569-18.699-10.708-25.837S302.44,109.633,292.359,109.633z")


    /** sad image **/
    var sadImage= svg.append("g")
      .attr("transform", "translate(10, 40) scale(.10)");


    sadImage.append("path")
      .attr("d", "M409.133,109.203c-19.608-33.592-46.205-60.189-79.798-79.796C295.736,9.801,259.058,0,219.273,0 c-39.781,0-76.47,9.801-110.063,29.407c-33.595,19.604-60.192,46.201-79.8,79.796C9.801,142.8,0,179.489,0,219.267 c0,39.78,9.804,76.463,29.407,110.062c19.607,33.592,46.204,60.189,79.799,79.798c33.597,19.605,70.283,29.407,110.063,29.407 s76.47-9.802,110.065-29.407c33.593-19.602,60.189-46.206,79.795-79.798c19.603-33.596,29.403-70.284,29.403-110.062 C438.533,179.485,428.732,142.795,409.133,109.203z M387.434,290.213c-9.709,22.556-22.696,41.97-38.969,58.245 c-16.271,16.269-35.689,29.26-58.245,38.965c-22.555,9.712-46.202,14.564-70.946,14.564c-24.744,0-48.391-4.853-70.948-14.564 c-22.554-9.705-41.971-22.696-58.245-38.965c-16.269-16.275-29.259-35.687-38.97-58.245 c-9.707-22.552-14.562-46.206-14.562-70.946c0-24.744,4.854-48.391,14.562-70.948c9.707-22.554,22.697-41.968,38.97-58.245 c16.274-16.269,35.691-29.26,58.245-38.97c22.554-9.704,46.205-14.558,70.948-14.558c24.74,0,48.395,4.851,70.946,14.558 c22.556,9.707,41.97,22.698,58.245,38.97c16.272,16.274,29.26,35.688,38.969,58.245c9.709,22.554,14.564,46.201,14.564,70.948 C402.002,244.011,397.143,267.664,387.434,290.213z")

    sadImage.append("path")
      .attr("d", "M284.368,258.668c-19.219-14.086-40.926-21.129-65.095-21.129c-24.172,0-45.871,7.039-65.096,21.129 c-19.224,14.085-32.358,32.641-39.397,55.671c-1.521,4.757-1.143,9.381,1.141,13.847c2.286,4.469,5.898,7.467,10.85,8.993 c4.758,1.526,9.373,1.143,13.846-1.144c4.471-2.285,7.467-5.899,8.991-10.848c4.759-15.235,13.562-27.556,26.409-36.979 c12.847-9.418,27.263-14.127,43.252-14.127c15.987,0,30.412,4.712,43.251,14.127c12.854,9.424,21.655,21.744,26.412,36.979 c1.52,4.948,4.564,8.562,9.134,10.848c4.568,2.286,9.236,2.67,13.989,1.144c4.761-1.526,8.278-4.524,10.564-8.993 c2.286-4.466,2.669-9.09,1.14-13.847C316.729,291.312,303.591,272.75,284.368,258.668z")

    sadImage.append("path")
      .attr("d", "M146.181,182.725c10.085,0,18.699-3.576,25.837-10.709c7.139-7.135,10.708-15.749,10.708-25.837 c0-10.089-3.569-18.699-10.708-25.837s-15.752-10.709-25.837-10.709c-10.088,0-18.702,3.571-25.84,10.709 c-7.135,7.139-10.707,15.749-10.707,25.837c0,10.088,3.568,18.702,10.707,25.837C127.482,179.152,136.093,182.725,146.181,182.725 z")

    sadImage.append("path")
      .attr("d", "M292.359,109.631c-10.089,0-18.706,3.571-25.845,10.709c-7.132,7.139-10.708,15.749-10.708,25.837 c0,10.088,3.576,18.702,10.708,25.837c7.139,7.137,15.756,10.709,25.845,10.709c10.081,0,18.698-3.576,25.837-10.709 c7.139-7.135,10.708-15.749,10.708-25.837c0-10.089-3.569-18.699-10.708-25.837S302.44,109.631,292.359,109.631z")
    }

  

</script>



</body>
</html>
